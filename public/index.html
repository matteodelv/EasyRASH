<!DOCTYPE html>
<html>

<head>
   <meta charset="utf-8" />
   <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
   <script src="//code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous"></script>
   <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
   <script src="js/bootstrap-notify.min.js"></script>
   <link rel="stylesheet" type="text/css" href="stylesheets/style.css">
   <link rel="stylesheet" type="text/css" href="stylesheets/animate.css">
   <link rel="stylesheet" type="text/css" href="stylesheets/sidebar.css">
   <script type="text/javascript">
   $.fn.extend({
      animateCss: function(animationName) {
         var animationEnd = 'webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend';
         $(this).addClass('animated ' + animationName).one(animationEnd, function() {
            $(this).removeClass('animated ' + animationName);
         });
         return $(this);
      }
   });
   $.ajaxSetup({
      beforeSend: function(xhr) {
         if (localStorage.accessToken) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.accessToken);
         }
      }
   });
   if (localStorage.accessToken) {
      $.ajax({
         url: '/api/verify',
         type: 'POST',
         success: function(result) {
            getPapers();
         },
         error: function(result) {
            $('#login-modal').modal('show');
         }
      });
   } else {
      $(window).load(function() {
         $('#login-modal').modal('show');
      });
   }
   </script>
   <title>Homepage</title>
</head>

<body>
   <div id="wrapper">
      <div id="sidebar-wrapper">
         <ul class="sidebar-nav">
         </ul>
      </div>
      <div id="page-content-wrapper">
         <div class="page-content">
            <div class="container-fluid">
               <div class="row">
                  <div class="col-md-12">
                     <!-- content of page -->
                     <h1>Welcome to a static file</h1>
                     <ul>
                        <li>
                           You can find papers at /api/papers/:id <a href="/api/papers/ciancarini-eswc2014">(example here)</a>
                        </li>
                        <li>
                           Authenticate at /api/authenticate with a POST request (email and password)
                        </li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
   <!-- Modal -->
   <div class="modal fade" id="login-modal" tabindex="-1" role="dialog" aria-labelledby="login dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog">
         <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
               <h4 class="modal-title" id="myModalLabel">Please login</h4>
            </div>
            <!-- Modal Body -->
            <div class="modal-body">
               <form role="form" id="loginpanel" action="javascript:auth()">
                  <div class="form-group">
                     <label for="email">Email address</label>
                     <input type="text" class="form-control" id="email" name="email" value="" placeholder="Email">
                  </div>
                  <div class="form-group">
                     <label for="password">Password</label>
                     <input type="password" class="form-control" id="password" name="password" value="" placeholder="Password">
                  </div>
               </form>
            </div>
            <!-- Modal Footer -->
            <div class="modal-footer">
               <span class="help-inline error"></span>
               <button type="submit" id="loginbutton" class="btn btn-primary" name="commit" value="Login">Login</button>
            </div>
         </div>
      </div>
</body>
<script>
function auth() {
   $.ajax({
      url: '/api/authenticate',
      type: 'POST',
      data: {
         email: $('#email').val(),
         password: $('#password').val()
      },
      success: function(result) {
         localStorage.accessToken = result.accessToken;
         $('#login-modal').modal('hide');
         $.notify({ //http://bootstrap-notify.remabledesigns.com/
            message: 'Welcome ' + result.id
         }, {
            type: 'success',
            delay: 2000
         });
         getPapers();
      },
      error: function(result) {
         $('#loginbutton').animateCss('shake').prev('.help-inline').animateCss('bounceIn').text(JSON.parse(result.responseText).message);
      }
   });
}

function getPapers() {
   $.ajax({
      url: '/api/papers/',
      type: 'GET',
      success: function(result) {
         var list = '<li class="sidebar-brand"><a href="#">Submitted</a></li>\n';
         result.submitted.forEach(article => {
            list += '<li><a href="'+ article.url +'">'+ article.title +'</a></li>\n'
         });
         list += '<li class="sidebar-brand"><a href="#">Reviewable</a></li>\n';
         result.reviewable.forEach(article => {
            list += '<li><a href="'+ article.url +'">'+ article.title +'</a></li>\n'
         });
         $('#sidebar-wrapper ul').html(list);
      },
      error: function(result) {
         alert(JSON.stringify(result));
      }
   });
}

$("#email, #password").keyup(function(event) {
   if (event.keyCode == 13) {
      auth();
   }
});
$('#loginbutton').click(function() {
   auth();
});
</script>

</html>
